#!/bin/tcsh -f

set cmd_dir=`dirname $0`
set filter_dir=${cmd_dir}/../busybeaver

setenv PATH ${PATH}:${cmd_dir}:${filter_dir}

set nprocs=$1
set basename=$2

set update_cmd="update_parallel ${nprocs}"

echo "----- Integrate -----"
time update ${basename} Initial_Filter

while (1)
  echo "----- Dual -----"
  time ${update_cmd} ${basename} Dual_Machine_Filter.py --tape=1000 --steps=1000

  set num_undecided=`ls -s ${basename}.undecided | awk '{print $1;}'`

  assign_undecided "${basename}" "${update_cmd}"

  if (${num_undecided} == 0) then
    break
  endif
end

echo "----- Reverse -----"
time ${update_cmd} ${basename} Reverse_Engineer_Filter.py

set time=0.1

run_tree_filter "${basename}" 10 1 2 ${time} "${update_cmd}"

echo "----- Reverse -----"
time ${update_cmd} ${basename} Reverse_Engineer_Filter.py

echo "----- Dual -----"
time ${update_cmd} ${basename} Dual_Machine_Filter.py --tape=1000 --steps=1000

assign_undecided "${basename}" "${update_cmd}"

run_tree_filter "${basename}" 100 1 5 ${time} "${update_cmd}"

foreach size (1)
  foreach ctl (1 2 3 4)
    set offset=0
    while (${offset} < ${size})
      echo "----- CTL${ctl} ${size} ${offset} ${time} -----"
      time ${update_cmd} ${basename} CTL_Filter.py --time=${time} --type=CTL${ctl} --size=${size} --offset=${offset}
      @ offset++
    end  
  end
end

assign_undecided "${basename}" "${update_cmd}"

run_tree_filter "${basename}" 1000 1 10 ${time} "${update_cmd}"

foreach size (2 3)
  foreach ctl (1 2 3 4)
    set offset=0
    while (${offset} < ${size})
      echo "----- CTL${ctl} ${size} ${offset} ${time} -----"
      time ${update_cmd} ${basename} CTL_Filter.py --time=${time} --type=CTL${ctl} --size=${size} --offset=${offset}
      @ offset++
    end  
  end
end

assign_undecided "${basename}" "${update_cmd}"

run_tree_filter "${basename}" 10000 1 25 ${time} "${update_cmd}"

foreach size (4 5 6)
  foreach ctl (1 2 3 4)
    set offset=0
    while (${offset} < ${size})
      echo "----- CTL${ctl} ${size} ${offset} ${time} -----"
      time ${update_cmd} ${basename} CTL_Filter.py --time=${time} --type=CTL${ctl} --size=${size} --offset=${offset}
      @ offset++
    end  
  end
end

assign_undecided "${basename}" "${update_cmd}"

set time=1.0

run_tree_filter "${basename}" 10000 1 25 ${time} "${update_cmd}"

foreach size (1 2 3 4 5 6)
  foreach ctl (1 2 3 4)
    set offset=0
    while (${offset} < ${size})
      echo "----- CTL${ctl} ${size} ${offset} ${time} -----"
      time ${update_cmd} ${basename} CTL_Filter.py --time=${time} --type=CTL${ctl} --size=${size} --offset=${offset}
      @ offset++
    end  
  end
end

assign_undecided "${basename}" "${update_cmd}"

set time=10.0

run_tree_filter "${basename}" 10000 1 25 ${time} "${update_cmd}"

foreach size (1 2 3 4 5 6)
  foreach ctl (1 2 3 4)
    set offset=0
    while (${offset} < ${size})
      echo "----- CTL${ctl} ${size} ${offset} ${time} -----"
      time ${update_cmd} ${basename} CTL_Filter.py --time=${time} --type=CTL${ctl} --size=${size} --offset=${offset}
      @ offset++
    end  
  end
end

assign_undecided "${basename}" "${update_cmd}"
